---
title: "Preprocess and prepare data for simulation"
output: html_document
---

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

```{r, echo = FALSE}
knitr::read_chunk("chunks.r")
```

```{r knitr-opts-chunk, include=FALSE}
```

---

## Background and objectives

Preprocess data for simulation

1. Remove spike-in control genes.  
2. Remove genes and samples with zero count.  
3. Remove mitochrodrial genes.

---

## MouseZeiselBrain

```{r, eval = FALSE}
library(singleCellRNASeqMouseZeiselBrain)
eset <- get(data(MouseZeiselBrain))
ngenes <- nrow(eset)
nsamples <- ncol(eset)

# remove genes/samples with zero count
ii_genes_allzero <- rowSums(exprs(eset) == 0) == ngenes
ii_samples_allzero <- colSums(exprs(eset) == 0) == nsamples
table(ii_genes_allzero)
table(ii_samples_allzero)

# remove spike-in control genes
which_genes_control <- grep("ERCC", rownames(exprs(eset)))

# remove mitochrondrial genes
mito <- readRDS("../data/mitogenes.mouse.rds")
which_notmito <- which(!(rownames(exprs(eset)) %in% as.character(mito$Symbol)))

# make filtered dataset
eset_filtered <- eset[which_notmito, ]

# save to rds
saveRDS(exprs(eset_filtered), 
        file = "../data/mousezeiselbrain.rds")
```

## MouseKleinESC

```{r, eval = FALSE}
library(singleCellRNASeqMouseKleinESC)
eset <- get(data(MouseKleinESC))
ngenes <- nrow(eset)
nsamples <- ncol(eset)

# remove genes/samples with zero count
ii_genes_allzero <- rowSums(exprs(eset) == 0) == ngenes
ii_samples_allzero <- colSums(exprs(eset) == 0) == nsamples
table(ii_genes_allzero)
table(ii_samples_allzero)

# remove spike-in control genes
which_genes_control <- grep("ERCC", rownames(exprs(eset)))

# remove mitochrondrial genes
mito <- readRDS("../data/mitogenes.mouse.rds")
which_notmito <- which(!(rownames(exprs(eset)) %in% as.character(mito$Symbol)))

# make filtered dataset
eset_filtered <- eset[which_notmito, ]

# save to rds
saveRDS(exprs(eset_filtered), 
        file = "../data/mousekleinesc.rds")
```


## HumanTungiPSC

```{r, eval = FALSE}
library(singleCellRNASeqHumanTungiPSC)
eset <- get(data(HumanTungiPSC))
ngenes <- nrow(eset)
nsamples <- ncol(eset)

# remove genes/samples with zero count
ii_genes_allzero <- rowSums(exprs(eset) == 0) == ngenes
ii_samples_allzero <- colSums(exprs(eset) == 0) == nsamples
table(ii_genes_allzero)
table(ii_samples_allzero)

# remove spike-in control genes
which_genes_notcontrol <- grep("ERCC", rownames(exprs(eset)), invert = TRUE)

# remove mitochrondrial genes
mito <- readRDS("../data/mitogenes.human.rds")
which_notmito <- which(!(rownames(exprs(eset)) %in% as.character(mito$Symbol)))

# make filtered dataset
eset_filtered <- eset[unique(which_genes_notcontrol, which_notmito), ]

# save to rds
saveRDS(exprs(eset_filtered), 
        file = "../data/humantungipsc.rds")
```


## GTEx

```{r, eval = FALSE}
library(data.table)
gtex <- data.frame(fread("../data/cis_gene_expression.txt"))
rownames(gtex) <- gtex[,2]
gtex <- gtex[,-c(1:2)]


# Extract liver data
tissue_labels <- data.frame(fread("../data/samples-id-for-paper.txt"))
liver_count <- gtex[,tissue_labels$SMTSD == "Liver"]
dim(liver_count)

# remove mitochrondrial genes
gene_symbols <- sapply(rownames(gtex), function(x) strsplit(x, split=".", fixed = TRUE)[[1]][1])
mito <- readRDS("../data/mitogenes.human.rds")
which_notmito <- which(!gene_symbols %in% as.character(mito$EnsemblGeneID) )

# make filtered dataset
gtex_filtered <- liver_count[which_notmito, ]
saveRDS(gtex_filtered, file = "../data/gtex.rds")

# thinning expression data
liver_thin001 <- apply(t(gtex_filtered), 1, function(x) rbinom(rep(1, length(x)), x, 0.001))
liver_thin01 <- apply(t(gtex_filtered), 1, function(x) rbinom(rep(1, length(x)), x, 0.01))

saveRDS(liver_thin001, file = "../data/gtex001.rds")
saveRDS(liver_thin01, file = "../data/gtex01.rds")
```


---

## Session information

```{r, echo = FALSE}
sessionInfo()
```

